<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Soporte - {{ config.app_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .main-content { background-color: #f8f9fa; min-height: 100vh; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .chat-container { height: 600px; display: flex; flex-direction: column; }
        .chat-list { height: 100%; overflow-y: auto; border-right: 1px solid #dee2e6; }
        .chat-messages { height: 100%; display: flex; flex-direction: column; }
        .message-list { flex: 1; overflow-y: auto; padding: 15px; }
        .message-input { border-top: 1px solid #dee2e6; padding: 15px; }
        .chat-item { cursor: pointer; transition: background-color 0.2s; }
        .chat-item:hover { background-color: #f8f9fa; }
        .chat-item.active { background-color: #e3f2fd; }
        .message { margin-bottom: 15px; max-width: 80%; }
        .message.user { margin-left: auto; }
        .message.admin { margin-right: auto; }
        .message-bubble { padding: 10px 15px; border-radius: 18px; word-wrap: break-word; }
        .message.user .message-bubble { background-color: #007bff; color: white; }
        .message.admin .message-bubble { background-color: #e9ecef; color: #212529; }
        .status-badge { font-size: 0.7rem; padding: 0.2rem 0.4rem; }
        .unread-badge { background-color: #dc3545; color: white; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.7rem; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3 text-white">
                    <h4><i class="fas fa-headset"></i> {{ config.app_name }}</h4>
                    <hr>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/vendors"><i class="fas fa-store"></i> Vendedores</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/drivers"><i class="fas fa-motorcycle"></i> Repartidores</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/vehicles"><i class="fas fa-car"></i> Renta Car</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="/admin/support-chat"><i class="fas fa-headset"></i> Chat de Soporte</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/alerts"><i class="fas fa-exclamation-triangle"></i> Alertas</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="p-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-headset"></i> Chat de Soporte</h2>
                            <p class="text-muted">Atención al cliente en tiempo real</p>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="loadSupportStats()">
                                <i class="fas fa-chart-bar"></i> Estadísticas
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="total-chats">0</h4>
                                    <small>Total Chats</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="active-chats">0</h4>
                                    <small>Activos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 id="waiting-chats">0</h4>
                                    <small>En Espera</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="resolved-chats">0</h4>
                                    <small>Resueltos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center">
                                    <h6 id="avg-response">0</h6>
                                    <small>Tiempo Respuesta</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-dark text-white">
                                <div class="card-body text-center">
                                    <h6 id="satisfaction">0</h6>
                                    <small>Satisfacción</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div class="card chat-container">
                        <div class="row h-100">
                            <!-- Chat List -->
                            <div class="col-md-4 chat-list">
                                <div class="p-3 border-bottom">
                                    <h6 class="mb-0"><i class="fas fa-comments"></i> Conversaciones</h6>
                                </div>
                                <div id="chat-list">
                                    <!-- Chats will be loaded here -->
                                </div>
                            </div>

                            <!-- Chat Messages -->
                            <div class="col-md-8 chat-messages">
                                <div id="chat-header" class="p-3 border-bottom" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0" id="current-chat-user">Selecciona un chat</h6>
                                            <small class="text-muted" id="current-chat-status"></small>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-success" onclick="resolveChat()">
                                                <i class="fas fa-check"></i> Resolver
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="message-list" class="message-list">
                                    <div class="text-center text-muted mt-5">
                                        <i class="fas fa-comments fa-3x mb-3"></i>
                                        <p>Selecciona una conversación para comenzar</p>
                                    </div>
                                </div>
                                
                                <div id="message-input" class="message-input" style="display: none;">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="message-text" 
                                               placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)">
                                        <button class="btn btn-primary" onclick="sendMessage()">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentChatId = null;
        let currentChatUser = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadChats();
            loadSupportStats();
        });

        function loadChats() {
            fetch('/admin/api/support-chats')
                .then(response => response.json())
                .then(data => {
                    displayChats(data);
                })
                .catch(error => {
                    console.error('Error loading chats:', error);
                    showAlert('Error cargando chats', 'danger');
                });
        }

        function displayChats(chats) {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item p-3 border-bottom';
                chatItem.onclick = () => selectChat(chat.id, chat.user_name, chat.user_type);
                
                const statusBadge = getStatusBadge(chat.status);
                const userTypeIcon = getUserTypeIcon(chat.user_type);
                const unreadBadge = chat.unread_count > 0 ? 
                    `<span class="unread-badge ms-2">${chat.unread_count}</span>` : '';

                chatItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <i class="${userTypeIcon} me-2"></i>
                                <strong>${chat.user_name}</strong>
                                ${unreadBadge}
                            </div>
                            <small class="text-muted">${chat.last_message}</small>
                            <div class="mt-1">
                                ${statusBadge}
                                <small class="text-muted ms-2">${formatTime(chat.last_message_time)}</small>
                            </div>
                        </div>
                    </div>
                `;
                chatList.appendChild(chatItem);
            });
        }

        function selectChat(chatId, userName, userType) {
            currentChatId = chatId;
            currentChatUser = userName;
            
            document.getElementById('current-chat-user').textContent = userName;
            document.getElementById('current-chat-status').textContent = `${getUserTypeLabel(userType)} • Activo`;
            document.getElementById('chat-header').style.display = 'block';
            document.getElementById('message-input').style.display = 'block';
            
            loadMessages(chatId);
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        function loadMessages(chatId) {
            fetch(`/admin/api/support-chats/${chatId}/messages`)
                .then(response => response.json())
                .then(data => {
                    displayMessages(data);
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    showAlert('Error cargando mensajes', 'danger');
                });
        }

        function displayMessages(messages) {
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender_type}`;
                
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-content">${message.message}</div>
                        <small class="text-muted">${formatTime(message.timestamp)}</small>
                    </div>
                `;
                messageList.appendChild(messageDiv);
            });
            
            messageList.scrollTop = messageList.scrollHeight;
        }

        function sendMessage() {
            if (!currentChatId) return;
            
            const messageText = document.getElementById('message-text').value.trim();
            if (!messageText) return;

            fetch(`/admin/api/support-chats/${currentChatId}/send-message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('message-text').value = '';
                    loadMessages(currentChatId);
                } else {
                    showAlert('Error enviando mensaje', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error enviando mensaje', 'danger');
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function resolveChat() {
            if (!currentChatId) return;
            
            if (confirm('¿Estás seguro de que quieres resolver este chat?')) {
                fetch(`/admin/api/support-chats/${currentChatId}/resolve`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Chat resuelto exitosamente', 'success');
                        loadChats();
                        resetChatView();
                    } else {
                        showAlert('Error resolviendo chat', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error resolviendo chat', 'danger');
                });
            }
        }

        function resetChatView() {
            currentChatId = null;
            currentChatUser = null;
            document.getElementById('chat-header').style.display = 'none';
            document.getElementById('message-input').style.display = 'none';
            document.getElementById('message-list').innerHTML = `
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>Selecciona una conversación para comenzar</p>
                </div>
            `;
        }

        function loadSupportStats() {
            fetch('/admin/api/support-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-chats').textContent = data.total_chats;
                    document.getElementById('active-chats').textContent = data.active_chats;
                    document.getElementById('waiting-chats').textContent = data.waiting_chats;
                    document.getElementById('resolved-chats').textContent = data.resolved_chats;
                    document.getElementById('avg-response').textContent = data.avg_response_time;
                    document.getElementById('satisfaction').textContent = data.satisfaction_rate + '/5';
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="badge bg-success status-badge">Activo</span>',
                'waiting': '<span class="badge bg-warning status-badge">En Espera</span>',
                'resolved': '<span class="badge bg-secondary status-badge">Resuelto</span>'
            };
            return badges[status] || '<span class="badge bg-secondary status-badge">Desconocido</span>';
        }

        function getUserTypeIcon(userType) {
            const icons = {
                'customer': 'fas fa-user',
                'seller': 'fas fa-store',
                'driver': 'fas fa-motorcycle'
            };
            return icons[userType] || 'fas fa-user';
        }

        function getUserTypeLabel(userType) {
            const labels = {
                'customer': 'Cliente',
                'seller': 'Vendedor',
                'driver': 'Repartidor'
            };
            return labels[userType] || 'Usuario';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alertDiv);
            setTimeout(() => { alertDiv.remove(); }, 5000);
        }

        setInterval(() => {
            if (currentChatId) {
                loadMessages(currentChatId);
            }
            loadChats();
        }, 30000);
    </script>
</body>
</html>
